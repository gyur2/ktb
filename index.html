<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Fruit & Veg Classifier ğŸ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 40px auto;
      padding: 0 16px;
      background-color: #f4f4f4;
    }
    h1 { color: #2b7cff; }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 16px;
    }
    #preview {
      margin-top: 12px;
      max-width: 240px;
      border-radius: 8px;
      border: 1px solid #ddd;
      display: none;
    }
    button {
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #2b7cff;
      color: white;
      font-size: 14px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .status { margin-top: 12px; white-space: pre-wrap; }
    .success { color: #0a7f1f; font-weight: bold; }
    .error { color: #c0392b; font-weight: bold; }
    .result-card {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .result-card h3 { margin-top: 0; margin-bottom: 6px; }
    .result-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <h1>Fruit & Vegetable Classification</h1>
  <p>ë¡œì»¬ FastAPI ì„œë²„ë¡œ ì´ë¯¸ì§€ë¥¼ ë³´ë‚´ ê³¼ì¼/ì•¼ì±„ë¥¼ ë¶„ë¥˜í•©ë‹ˆë‹¤.</p>

  <div class="card">
    <label for="fileInput">ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (jpg / png)</label><br />
    <input id="fileInput" type="file" accept="image/jpeg,image/png" />

    <div id="previewContainer">
      <img id="preview" src="" alt="preview" />
      <div id="previewCaption"></div>
    </div>

    <button id="predictBtn" type="button">Predict</button>

    <!-- ìƒíƒœ ë©”ì‹œì§€ ì˜ì—­ -->
    <div id="status" class="status"></div>
  </div>

  <!-- ê²°ê³¼ ì¹´ë“œ ì˜ì—­ -->
  <div id="resultsContainer"></div>

  <script>
    let BACKEND_URL;
    if (window.location.port === "8000") {
      // FastAPIê°€ index.htmlì„ ì„œë¹™í•˜ëŠ” ê²½ìš°
      BACKEND_URL = "/predict-fruit-veg";
    } else {
      // VSCode Live Server(ë³´í†µ 5500) ë“±ìœ¼ë¡œ ì—¬ëŠ” ê²½ìš°
      BACKEND_URL = "http://127.0.0.1:8000/predict-fruit-veg";
    }
    console.log("BACKEND_URL =", BACKEND_URL);

    const fileInput = document.getElementById("fileInput");
    const predictBtn = document.getElementById("predictBtn");
    const previewImg = document.getElementById("preview");
    const previewCaption = document.getElementById("previewCaption");
    const statusDiv = document.getElementById("status");
    const resultsContainer = document.getElementById("resultsContainer");

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) {
        previewImg.style.display = "none";
        previewCaption.textContent = "";
        return;
      }
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewImg.style.display = "block";
      previewCaption.textContent = "Input Image: " + file.name;
    });

    // Predict ë²„íŠ¼
    predictBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      statusDiv.className = "status";
      statusDiv.textContent = "";

      if (!file) {
        statusDiv.className = "status error";
        statusDiv.textContent = "ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.";
        return;
      }

      predictBtn.disabled = true;
      statusDiv.textContent = "â³ ì„œë²„ì— ìš”ì²­ ì¤‘...";

      const formData = new FormData();
      formData.append("file", file, file.name);

      try {
        console.log("POST to", BACKEND_URL);
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          body: formData,
        });

        statusDiv.textContent = `Status code: ${res.status}`;

        if (!res.ok) {
          const text = await res.text();
          statusDiv.className = "status error";
          statusDiv.textContent += "\nìš”ì²­ ì‹¤íŒ¨";
          console.error("ì—ëŸ¬ ì‘ë‹µ:", text);
          return;
        }

        const data = await res.json();
        console.log("ì‘ë‹µ JSON:", data);

        const top1Label = data.top1_label;
        const top1Score = data.top1_score;
        const probs = data.probabilities || {};

        // ê²°ê³¼ ì¹´ë“œ ìƒì„±
        const card = document.createElement("div");
        card.className = "result-card";

        const title = document.createElement("h3");
        title.textContent = `ì˜ˆì¸¡ ê²°ê³¼: ${top1Label}`;
        card.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "result-meta";
        meta.textContent =
          `score: ${Number(top1Score).toFixed(4)} â€¢ ` +
          new Date().toLocaleTimeString();
        card.appendChild(meta);

        const entries = Object.entries(probs)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        if (entries.length > 0) {
          const ul = document.createElement("ul");
          for (const [label, prob] of entries) {
            const li = document.createElement("li");
            li.innerHTML =
              `<strong>${label}</strong>: ${Number(prob).toFixed(4)}`;
            ul.appendChild(li);
          }
          card.appendChild(ul);
        }

        if (resultsContainer.firstChild) {
          resultsContainer.insertBefore(card, resultsContainer.firstChild);
        } else {
          resultsContainer.appendChild(card);
        }

        statusDiv.className = "status success";
        statusDiv.textContent += "\nì˜ˆì¸¡ ì™„ë£Œ!";
      } catch (err) {
        statusDiv.className = "status error";
        statusDiv.textContent =
          "ìš”ì²­ ì¤‘ ë„¤íŠ¸ì›Œí¬/JS ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err;
        console.error(err);
      } finally {
        predictBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
